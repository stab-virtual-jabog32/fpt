%h1 Edit loadout for #{@flight.full_callsign}

%img(src="/loadout/#{@flight.airframe}.png" width=600)

= form_for @loadout, url: flight_loadout_path(@flight), method: :put do |f|
  = f.hidden_field :g
  %table.table.table-striped.table-bordered.table-sm.table-hover
    %tr
      %th.bg-secondary Station
      %th.bg-secondary(colspan=4) Payload
      %th.bg-secondary Weight
    - @stations.each do |station|
      %tr
        %th.table-secondary= station.number
        %td(colspan=4)= f.select station.number, station_options(station, f.object.send(station.number)), {}, class: 'form-control form-control-sm'
        %td(data-ref="loadout_#{station.number}")

    %tr
      %th.bg-secondary(colspan=6) Gun
    %tr
      %th.table-secondary Amount
      %td= f.range_field :g, class: 'custom-range', data: { amount: Settings.airframes[@flight.airframe].gun.amount, weight: Settings.airframes[@flight.airframe].gun.weight }
      %td#gun_amount

    %tr
      %th.bg-secondary Expendables
      %td(colspan=2)= f.select :e, expendable_options(@flight), {}, class: 'form-control form-control-sm'
      %td(colspan=3)

    %tr
      %th.bg-secondary(colspan=6) Fuel
    %tr
      %th.table-secondary Internal
      %td= f.range_field :f, class: 'custom-range', data: { weight: Settings.airframes[@flight.airframe].weight.fuel }
      %td#internal_fuel
      %th.table-secondary External
      %td#external_fuel
      %td#total_fuel

    %tr
      %th.bg-secondary(colspan=6) Weight
    %tr
      %th.table-secondary Empty
      %th.table-secondary Max TO/L
      %th.table-secondary Max Flt
      %th.table-secondary Payload
      %th.table-secondary Fuel
      %th.table-secondary Total
    %tr
      %td#empty_weight= Settings.airframes[@flight.airframe].weight.empty
      %td= Settings.airframes[@flight.airframe].weight.tol
      %td= Settings.airframes[@flight.airframe].weight.flt
      %td#payload_weight
      %td#fuel_weight
      %td#total_weight{ data: { max: Settings.airframes[@flight.airframe].weight.tol } }

  = f.submit 'Save Loadout', class: 'btn btn-primary'

/ Additions for loadout template functionality
%h3 Load from Template

/ Feedback Section for displaying feedback messages
%div#template-feedback{ style: "display: none;" }

/ Check if there are templates present for this airframe
- if @templates.present? && @templates.any?
  = form_with url: load_template_flight_loadout_path(@flight), method: :post, remote: true, id: "load-template-form" do |f|
    %div.form-group
      = f.label :template_id, 'Select a template to load'
      = f.select :template_id, @templates.map { |t| [t.name, t.id] }, {}, class: 'form-control'
    = f.submit 'Load Template', class: 'btn btn-secondary'
- else
  %p No templates available for this airframe.

%h3 Save as Template
= form_with url: save_template_flight_loadout_path(@flight), method: :post, remote: true do |f|
  %div.form-group
    = f.label :template_name, 'Save current loadout as template:'
    = f.text_field :template_name, class: 'form-control'

  - @stations.each do |station|
    = f.hidden_field "loadout[#{station.number}]", value: @loadout[station.number] # Ensure the stations are passed
  = f.hidden_field "loadout[f]", value: @loadout.f
  = f.hidden_field "loadout[e]", value: @loadout.e
  = f.hidden_field "loadout[g]", value: @loadout.g

  = f.submit 'Save as Template', class: 'btn btn-primary'


= link_to 'Back', flight_path(@flight)
